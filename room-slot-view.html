<!DOCTYPE html>
<html>
    <head>
        <title>Class Routine</title>
        <style>
            table {
                border-collapse: collapse;
                width: 100%;
                text-align: center;
            }

            table,
            th,
            td {
                border: 1px solid black;
            }

            th,
            td {
                padding: 10px;
            }

            .empty-cell {
                background-color: #f5f5f5;
                text-align: center;
            }

            .book-button {
                background-color: #4caf50;
                color: white;
                padding: 6px 12px;
                border: none;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <input type="text" id="data" placeholder="Enter Day" />
        <button onclick="handleSubmit()">Submit</button>
        <a href="day-slot-view.html">Daily Routine</a>
        <div id="class-routine"></div>

        <script>
            var jsonData;
            var temporaryData;
            var query = "";
            const url = "http://localhost/diu-routine/data.php?";
            const bookingURL = "http://localhost/diu-routine/book.php?";
            const temporaryUrl =
                "http://localhost/diu-routine/temporary-class.php?";
            const input = document.getElementById("data");
            const routineTable = document.getElementById("class-routine");

            function handleSubmit() {
                document.getElementById("class-routine").innerHTML = "";
                query = url + "day=" + input.value;
                query_temp = temporaryUrl + "day=" + input.value;
                Promise.all([
                    fetch(query).then((response) => response.json()),
                    fetch(query_temp).then((response) => response.json()),
                ])
                    .then(([dataResponse, temporaryResponse]) => {
                        jsonData = dataResponse;
                        temporaryData = temporaryResponse;

                        const mergedData = jsonData.concat(temporaryData);

                        const slots = new Set();
                        const rooms = new Set();

                        mergedData.forEach((item) => {
                            slots.add(item.slot);
                            rooms.add(item.room);
                        });

                        const slotArray = Array.from(slots).sort(
                            (a, b) => a - b
                        );
                        const roomArray = Array.from(rooms).sort(
                            (a, b) => a - b
                        );

                        const table = document.createElement("table");

                        const headerRow = document.createElement("tr");
                        const headerCell = document.createElement("th");
                        headerRow.appendChild(headerCell);

                        slotArray.forEach((slot) => {
                            const cell = document.createElement("th");
                            cell.textContent = `Slot ${slot}`;
                            headerRow.appendChild(cell);
                        });

                        table.appendChild(headerRow);

                        roomArray.forEach((room) => {
                            const roomRow = document.createElement("tr");
                            const roomCell = document.createElement("td");
                            roomCell.textContent = `Room ${room}`;
                            roomRow.appendChild(roomCell);

                            slotArray.forEach((slot) => {
                                const coursesInSlotAndRoom = mergedData.filter(
                                    (item) =>
                                        item.slot === slot && item.room === room
                                );
                                const cell = document.createElement("td");

                                if (coursesInSlotAndRoom.length > 0) {
                                    coursesInSlotAndRoom.forEach(
                                        (courseInfo) => {
                                            const courseDiv =
                                                document.createElement("div");
                                            courseDiv.innerHTML = `${courseInfo.course}<br>${courseInfo.teacher}<br>${courseInfo.batch}`;
                                            if (courseInfo.date) {
                                                courseDiv.innerHTML += `<br><span style="color:red">Date: ${courseInfo.date}</a>`;
                                            }
                                            cell.appendChild(courseDiv);
                                        }
                                    );
                                } else {
                                    const button =
                                        document.createElement("button");
                                    button.className = "book-button";
                                    button.textContent = "Book the room";
                                    button.onclick = function () {
                                        book(room, slot, input.value);
                                    };
                                    cell.appendChild(button);
                                }

                                roomRow.appendChild(cell);
                            });

                            table.appendChild(roomRow);
                        });

                        document
                            .getElementById("class-routine")
                            .appendChild(table);
                    })
                    .catch((error) => {
                        console.log("Error:", error);
                    });
            }

            function book(room_no, slot, day) {
                //alert(`Booking Room ${room_no}, Slot ${slot}, Day ${day}`);
                //const url = "https://google.com";
                //window.open(url, '_blank', features);
                let course = prompt("Enter course code: ");
                let batch = prompt("Enter batch no: ");

                fetch(
                    bookingURL +
                        "batch=" +
                        batch +
                        "&course=" +
                        course +
                        "&day=" +
                        day +
                        "&slot=" +
                        slot +
                        "&room=" +
                        room_no
                )
                    .then((response) => response.text())
                    .then((result) => {
                        alert(result);
                        handleSubmit();
                    })
                    .catch((error) => {
                        alert("Error:" + error);
                    });
            }
        </script>
    </body>
</html>
