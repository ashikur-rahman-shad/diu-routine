<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            table {
                border-collapse: collapse;
                width: 100%;
                text-align: center;
            }

            table,
            th,
            td {
                border: 1px solid black;
            }

            th,
            td {
                padding: 10px;
            }
            .cancel-button {
                background-color: #ff0000;
                color: white;
                padding: 6px 12px;
                border: none;
                cursor: pointer;
            }
        </style>
    </head>
    <body style="text-align: center">
        <div>
            <h1>DIU Routine - SWE</h1>
            <div class="top-navigation">
                <a href="./login.php"> Login</a> &bull;
                <a href="./"> Home</a> &bull;
                <a href="./dashboard.html"> Dashboard</a> &bull;
                <a href="./day-slot-view.html"> Day wise routine</a> &bull;
                <a href="./room-slot-view.html"> Room wise routine</a> &bull;
                <br />
                <br />
            </div>
        </div>

        <div id="class-routine"></div>
        <h2>Makeup classes</h2>
        <div id="makeup-class"></div>
        <h2>Extra classes</h2>
        <div id="extra-class"></div>

        <script>
            var jsonData;
            var temporaryData;
            var query = "";
            const url = "./data.php?";
            const temporaryUrl = "./temporary-class.php?";
            const section = document.getElementById("section");
            const routineTable = document.getElementById("class-routine");

            var teacher;
            fetch("./teacher.php")
                .then((response) => response.text())
                .then((result) => {
                    teacher = result;
                    handleSubmit();
                })
                .catch((error) => {
                    alert("Error:" + error);
                });

            function handleSubmit() {
                query = url + "teacher=" + teacher;
                temporaryQuery = temporaryUrl + "teacher=" + teacher;

                // Fetch data from both URLs concurrently using Promise.all
                Promise.all([
                    fetch(query).then((response) => response.json()),
                    fetch(temporaryQuery).then((response) => response.json()),
                ])
                    .then(([data, temporaryData]) => {
                        jsonData = data;
                        this.temporaryData = temporaryData;
                        const mergedData = jsonData.concat(temporaryData);
                        document.getElementById("class-routine").innerHTML =
                            createTable(mergedData);
                    })
                    .catch((error) => {
                        console.log("Error:", error);
                    });
            }

            function createTableRow(day, slots) {
                let row = "<tr><td>" + day + "</td>";

                // Group courses by day and slot
                let groupedCourses = {};
                slots.forEach((course) => {
                    const key = course.day + "_" + course.slot;
                    if (!groupedCourses.hasOwnProperty(key)) {
                        groupedCourses[key] = [];
                    }
                    groupedCourses[key].push(course);
                });

                for (let i = 1; i <= 9; i++) {
                    const key = day + "_" + i;
                    let courses = groupedCourses[key];
                    if (courses) {
                        row += "<td>";
                        row += courses
                            .map((course) => {
                                let courseInfo = `${course.course} <br> Batch ${course.batch} <br>  (${course.room})`;
                                if (course.classtype && course.date) {
                                    courseInfo += `<br><span style="color:red">(${course.classtype} class) <br>Date: ${course.date}</span>`;
                                    if (course.teacher == teacher) {
                                        courseInfo += `<br><button class="cancel-button" onclick="cancel('${courseInfo.day}','${courseInfo.slot}','${courseInfo.room}')">Cancel</button> </a>`;
                                    }
                                }
                                return courseInfo;
                            })
                            .join("<hr>");
                        row += "</td>";
                    } else {
                        row += "<td></td>";
                    }
                }
                row += "</tr>";
                return row;
            }

            function groupByDay(dataArray) {
                let groupedData = {};
                dataArray.forEach((course) => {
                    if (!groupedData.hasOwnProperty(course.day)) {
                        groupedData[course.day] = [];
                    }
                    groupedData[course.day].push(course);
                });
                return groupedData;
            }

            function createTable(dataArray) {
                const groupedData = groupByDay(dataArray);
                let table =
                    "<table><thead><tr><th>Days/Slots</th><th>Slot 1</th><th>Slot 2</th><th>Slot 3</th><th>Slot 4</th><th>Slot 5</th><th>Slot 6</th><th>Slot 7</th><th>Slot 8</th><th>Slot 9</th></tr></thead><tbody>";

                for (const [day, slots] of Object.entries(groupedData)) {
                    table += createTableRow(day, slots);
                }

                table += "</tbody></table>";
                return table;
            }

            function cancel(day, slot, room) {
                fetch(
                    cancelURL + "day=" + day + "&slot=" + slot + "&room=" + room
                )
                    .then((response) => response.text())
                    .then((result) => {
                        alert(result);
                        handleSubmit();
                    })
                    .catch((error) => {
                        alert("Error:" + error);
                    });
            }
            
        </script>
    </body>
</html>
